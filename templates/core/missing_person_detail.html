{%extends "base.html"%}

{%block title%}{{ missing_person.name }} - Missing Person - KNMPDB{%endblock title%}

{%block content%}
<div class="container py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <div>
                            <h1 class="text-primary mb-2">{{ missing_person.name }}</h1>
                            <span class="badge bg-danger fs-6 px-3 py-2">
                                <i class="fas fa-exclamation-circle me-2"></i>{{ missing_person.get_status_display }}
                            </span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Reported on</small>
                            <strong>{{ missing_person.created_at|date:"F d, Y" }}</strong>
                        </div>
                    </div>

                    <!-- Photos Section -->
                    {% if missing_person.photos.all %}
                    <div class="mb-4">
                        <h4 class="text-dark mb-3">
                            <i class="fas fa-images me-2"></i>Photos
                        </h4>
                        <div class="row">
                            {% for photo in missing_person.photos.all %}
                            <div class="col-md-6 mb-3">
                                <div class="photo-container">
                                    <img src="{{ photo.photo.url }}"
                                        alt="{{ photo.alternative_text|default:missing_person.name }}"
                                        class="img-fluid rounded shadow-sm photo-zoom" data-bs-toggle="modal"
                                        data-bs-target="#photoModal{{ forloop.counter }}">
                                    {% if photo.is_primary %}
                                    <span class="badge bg-primary photo-badge">Primary</span>
                                    {% endif %}
                                    {% if photo.description %}
                                    <div class="mt-2">
                                        <small class="text-muted">{{ photo.description }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Photo Modal -->
                            <div class="modal fade" id="photoModal{{ forloop.counter }}" tabindex="-1">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ missing_person.name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img src="{{ photo.photo.url }}"
                                                alt="{{ photo.alternative_text|default:missing_person.name }}"
                                                class="img-fluid">
                                            {% if photo.description %}
                                            <p class="mt-3 text-muted">{{ photo.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h4 class="text-dark mb-3">
                            <i class="fas fa-user me-2"></i>Basic Information
                        </h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">Gender</strong>
                                    <span class="fs-5">{{ missing_person.get_gender_display }}</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">Age</strong>
                                    <span class="fs-5">{{ missing_person.age|default:"Unknown" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="mb-4">
                        <h4 class="text-dark mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>Location Information
                        </h4>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">Last Seen Location</strong>
                                    <span class="fs-5">{{ missing_person.last_seen_location }}</span>
                                </div>
                            </div>
                            {% if missing_person.county or missing_person.sub_county or missing_person.ward %}
                            <div class="col-md-4 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">County</strong>
                                    <span>{{ missing_person.county|default:"Not specified" }}</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">Sub County</strong>
                                    <span>{{ missing_person.sub_county|default:"Not specified" }}</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="info-item">
                                    <strong class="text-muted d-block">Ward</strong>
                                    <span>{{ missing_person.ward|default:"Not specified" }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h4 class="text-dark mb-3">
                            <i class="fas fa-info-circle me-2"></i>Description
                        </h4>
                        <div class="description-box p-3 bg-light rounded">
                            <p class="mb-0">{{ missing_person.description|linebreaks }}</p>
                        </div>
                    </div>

                    <!-- Emergency Notice -->
                    <div class="alert alert-danger mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Have you seen this person?</h5>
                                <p class="mb-0">If you have any information about {{ missing_person.name }}, please
                                    contact the authorities or the contact persons listed below immediately.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Contact Information -->
            {% if missing_person.contacts.all %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-phone me-2"></i>Contact Information
                    </h5>
                </div>
                <div class="card-body">
                    {% for contact in missing_person.contacts.all %}
                    <div class="contact-item mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                        <h6 class="text-primary mb-2">{{ contact.name }}</h6>
                        <div class="contact-details">
                            <div class="mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <a href="tel:{{ contact.phone_number }}" class="text-decoration-none">
                                    {{ contact.phone_number }}
                                </a>
                            </div>
                            {% if contact.email %}
                            <div class="mb-2">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <a href="mailto:{{ contact.email }}" class="text-decoration-none">
                                    {{ contact.email }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Share Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-share me-2"></i>Help Spread the Word
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Share this missing person report to help reach more people:</p>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" onclick="shareWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>Share on WhatsApp
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="shareFacebook()">
                            <i class="fab fa-facebook me-2"></i>Share on Facebook
                        </button>
                        <button class="btn btn-dark btn-lg" onclick="shareTwitter()">
                            <i class="fab fa-x-twitter me-2"></i>Share on X (Twitter)
                        </button>
                        <button class="btn btn-outline-secondary btn-lg" onclick="copyLink()">
                            <i class="fas fa-link me-2"></i>Copy Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Emergency Contacts -->
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>Emergency Contacts
                    </h5>
                </div>
                <div class="card-body">
                    <div class="emergency-contact mb-3">
                        <h6 class="text-danger">Police Emergency</h6>
                        <a href="tel:999" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-phone me-1"></i>999
                        </a>
                    </div>
                    <div class="emergency-contact mb-3">
                        <h6 class="text-primary">Missing Persons Unit</h6>
                        <a href="tel:+254700000000" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-phone me-1"></i>+254 700 000 000
                        </a>
                    </div>
                    <small class="text-muted">
                        If you have immediate information about this missing person, please contact emergency services
                        directly.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Navigation -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'core:all_missing_persons' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to All Missing Persons
                </a>
                <a href="{% url 'core:report_missing' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Report a Missing Person
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Get page URL and create share content
    const pageUrl = window.location.href;
    const missingPersonName = "{{ missing_person.name|escapejs }}";
    const shareText = `MISSING PERSON ALERT: ${missingPersonName} is missing. Last seen at {{ missing_person.last_seen_location|escapejs }}. Please share to help find them. More details:`;

    function shareWhatsApp() {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + pageUrl)}`;
        window.open(whatsappUrl, '_blank');
    }

    function shareFacebook() {
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
        window.open(facebookUrl, '_blank', 'width=600,height=400');
    }

    function shareTwitter() {
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`;
        window.open(twitterUrl, '_blank', 'width=600,height=400');
    }

    function copyLink() {
        navigator.clipboard.writeText(pageUrl).then(function () {
            // Show success message
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Link Copied!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');

            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function () {
            alert('Unable to copy link. Please copy the URL manually.');
        });
    }

    // Add click event for photo zoom
    document.addEventListener('DOMContentLoaded', function () {
        const photos = document.querySelectorAll('.photo-zoom');
        photos.forEach(photo => {
            photo.style.cursor = 'pointer';
            photo.addEventListener('click', function () {
                // Bootstrap modal will handle the display
            });
        });
    });
</script>
{%endblock content%}